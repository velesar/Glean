name: Deploy to Fly.io

on:
  push:
    branches:
      - main
      - master
      - claude/add-claude-documentation-Q6Qc8
  workflow_dispatch:

env:
  FLY_APP_NAME: glean-ayusuw
  FLY_REGION: iad

jobs:
  deploy:
    name: Deploy to Fly.io
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Check and create volume
        run: |
          # Check if volume exists
          VOLUMES=$(flyctl volumes list -a "$FLY_APP_NAME" 2>/dev/null || echo "")
          if echo "$VOLUMES" | grep -q "glean_data"; then
            echo "Volume glean_data already exists"
          else
            echo "Creating volume glean_data..."
            flyctl volumes create glean_data \
              --region "$FLY_REGION" \
              --size 1 \
              --app "$FLY_APP_NAME" \
              --yes
            echo "Volume created successfully"
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Set secrets if not exists
        run: |
          # Check if GLEAN_SECRET_KEY is set
          SECRETS=$(flyctl secrets list -a "$FLY_APP_NAME" 2>/dev/null || echo "")
          if echo "$SECRETS" | grep -q "GLEAN_SECRET_KEY"; then
            echo "GLEAN_SECRET_KEY already set"
          else
            echo "Setting GLEAN_SECRET_KEY..."
            flyctl secrets set GLEAN_SECRET_KEY="$(openssl rand -hex 32)" -a "$FLY_APP_NAME"
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Deploy to Fly.io
        run: flyctl deploy --remote-only -a "$FLY_APP_NAME"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Show deployment info
        run: |
          echo "Deployment complete!"
          echo "App URL: https://$FLY_APP_NAME.fly.dev"
          flyctl status -a "$FLY_APP_NAME"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Health check
        run: |
          echo "Waiting for app to be ready..."
          sleep 10
          curl -sf "https://$FLY_APP_NAME.fly.dev/api/health" || echo "Health check pending..."
